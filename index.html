<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Grocery List</title>

    <link rel="shortcut icon" href="favicon.ico">

    <!-- Sets initial viewport load and disables zooming  -->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

    <!-- Makes your prototype chrome-less once bookmarked to your phone's home screen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <!-- Include the compiled Ratchet CSS -->
    <link href="css\ratchet.css" rel="stylesheet">
    <link href="css\ratchet-theme-ios.min.css" rel="stylesheet">

    <!-- Include the compiled Ratchet JS -->
    <script src="js\ratchet.min.js"></script>
    <script type="text/javascript" src="js\jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="js\jquery.autocomplete.min.js"></script>

    <link href="css\autocomplete.css" rel="stylesheet">

    <script type="text/javascript">
      // Array Remove - By John Resig (MIT Licensed)
      Array.prototype.remove = function(from, to) {
        var rest = this.slice((to || from) + 1 || this.length);
        this.length = from < 0 ? this.length + from : from;
        return this.push.apply(this, rest);
      };
    </script>

    <script src="js\grocerylist.js"></script>
    <script type="text/javascript">
      var itemsList = [];

      if (localStorage['itemsList'])
      {
        itemsList = JSON.parse(localStorage['itemsList']);
      }

      ModesEnum = {
        PlanTab : 0,
        ShopTab : 1
      };

      var mode = ModesEnum.PlanTab;

      function PlanUi() {
        $(".content").append("<ul class=\"table-view\"></ul>");

        var list = $(".content .table-view");
        var anyDoneItems = false;
        for (var idx = 0; idx < itemsList.length; ++idx)
        {
          var item = itemsList[idx];
          if (!item.done) {
            list.append("<li itemIdx=\"" + idx + "\" class=\"table-view-cell\"><span style=\"padding-left:10px\">" + item.text +"</span></li>");
          }
        }

        $("#addItem").show();
        $("#editItems").show();
      }

      function ShopUi() {        
        $(".content").append("<ul class=\"table-view\"></ul>");
        var list = $(".content .table-view");
        var anyDoneItems = false;
        for (var idx = 0; idx < itemsList.length; ++idx)
        {
          var item = itemsList[idx];
          if (!item.done) {
            list.append("<li itemIdx=\"" + idx + "\" class=\"table-view-cell\"><input type=\"checkbox\"/><span style=\"padding-left:10px\">" + item.text +"</span></li>");
          } else {
            anyDoneItems = true;
          }
        }

        if (anyDoneItems) {
          list.append("<li id=\"table-divider\" class=\"table-view-cell table-view-divider\">Done</li>");
          for (var idx = 0; idx < itemsList.length; ++idx)
          {
            var item = itemsList[idx];
            if (item.done) {            
              list.append("<li itemIdx=\"" + idx + "\" class=\"table-view-cell\"><input type=\"checkbox\" checked=\"checked\"/><span style=\"padding-left:10px\">" + item.text +"</span></li>");
            }
          }
        }

        $(".content .table-view li input").click(function() {
            var itemIdx = $(this).parent().attr("itemIdx");

            if (this.checked) {
              itemsList[itemIdx].done = true;
            } else {
              itemsList[itemIdx].done = false;
            }

            updateUi();
        });

        $("#addItem").hide();
        $("#editItems").hide();
      }

      function updateUi() {
        $(".content").empty();

        if (mode == ModesEnum.PlanTab) {
          $("#PlanTab").addClass("active");
          $("#ShopTab").removeClass("active");
          PlanUi();
        } else if (mode == ModesEnum.ShopTab) {
          $("#PlanTab").removeClass("active");
          $("#ShopTab").addClass("active");
          ShopUi();
        }        
      }

      $(document).ready(function() {
          $("#addItem").click(function() {
              $(".content .table-view").prepend("<input id=\"newItemEdit\"type=\"text\" placeholder=\"new item\"/>");
              
              $(":input").autocomplete({ 
                lookup: groceries,
                onSelect: function (suggestion) {
                  $("#newItemEdit").focus();
                }
              });

              $(":input").blur(function() {
                if ($(".autocomplete-suggestions:visible").length == 0) {
                  var itemText = $("#newItemEdit").val();
                  $("#newItemEdit").remove();
                  
                  if (itemText)
                  {
                    itemsList.push({ text:itemText, done:false});
                    localStorage['itemsList'] = JSON.stringify(itemsList);
                    updateUi();
                  }
                }
              });
              $("#newItemEdit").focus();
          });

          $("#editItems").click(function() {
              $("#editItems").hide();
              $("#addItem").hide();
              $("#doneEditItems").show();
              $(".table-view .table-view-cell").not('.table-view-divider').append("<button class=\"btn btn-negative btn-remove\">Remove</button>");
              $(".btn-remove").click(function() {
                if ($(this).hasClass("btn-negative")) {
                  $(this).parent().css("text-decoration", "line-through");
                  $(this).text("Cancel");
                  $(this).removeClass("btn-negative");
                  $(this).addClass("btn-primary");
                } else {
                  $(this).parent().css("text-decoration", "");
                  $(this).text("Remove");
                  $(this).removeClass("btn-primary");
                  $(this).addClass("btn-negative");                  
                }
              });
          });

          $("#doneEditItems").click(function() {
              $(".table-view .table-view-cell").filter(function() {
                return $(this).css('text-decoration').indexOf("line-through") != -1;
              }).each(function() {
                var idx = parseInt($(this).attr("itemIdx"));
                delete itemsList[idx];
              })

              itemsList = jQuery.grep(itemsList, function(item){
                  return item !== undefined;
              });
              localStorage['itemsList'] = JSON.stringify(itemsList);

              $("#doneEditItems").hide();
              $("#editItems").show();
              $("#addItem").show();
              updateUi();
          });

          $(".tab-item").click(function() {
              mode = ModesEnum[$(this)[0].id];
              updateUi();
          });

          updateUi();
      });
    </script>
  </head>
  <body>

    <!-- Make sure all your bars are the first things in your <body> -->
    <header class="bar bar-nav">
      <a id="addItem" class="icon icon-plus pull-left"></a>
      <button id="editItems" class="btn pull-right">Edit</button>
      <button id="doneEditItems" class="btn pull-right btn-positive" style="display:none">Done</button>
      <h1 class="title">Grocery List</h1>
    </header>

    <!-- Wrap all non-bar HTML in the .content div (this is actually what scrolls) -->
    <div class="content">
    </div>

    <nav class="bar bar-tab">
      <a id="PlanTab" class="tab-item" href="#">
        <span class="icon icon-list"></span>
        <span class="tab-label">Plan</span>
      </a>
      <a id="ShopTab" class="tab-item" href="#">
        <span class="icon icon-gear"></span>
        <span class="tab-label">Shop</span>
      </a>
    </nav>
  </body>
</html>