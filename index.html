<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Grocery List</title>

    <link rel="shortcut icon" href="favicon.ico">

    <!-- Sets initial viewport load and disables zooming  -->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

    <!-- Makes your prototype chrome-less once bookmarked to your phone's home screen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <!-- Include the compiled Ratchet CSS -->
    <link href="css\ratchet.css" rel="stylesheet">
    <link href="css\ratchet-theme-ios.min.css" rel="stylesheet">

    <!-- Include the compiled Ratchet JS -->
    <script src="js\ratchet.min.js"></script>
    <script type="text/javascript" src="js\jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="js\jquery.autocomplete.min.js"></script>

    <link href="css\autocomplete.css" rel="stylesheet">

    <script type="text/javascript">
      // Array Remove - By John Resig (MIT Licensed)
      Array.prototype.remove = function(from, to) {
        var rest = this.slice((to || from) + 1 || this.length);
        this.length = from < 0 ? this.length + from : from;
        return this.push.apply(this, rest);
      };
    </script>

    <script src="js\grocerylist.js"></script>
    <script src="js\storeslist.js"></script>

    <script type="text/javascript">
      var itemsList = [];
      var currentLocation = {
        latitude: 0,
        longitude: 0
      }

      var decideMode = true;

      if (localStorage['itemsList'])
      {
        itemsList = JSON.parse(localStorage['itemsList']);
        for (var i = itemsList.length - 1; i >= 0; i--) {
          if (itemsList[i].date) {
            itemsList[i].date = new Date(itemsList[i].date);
          }          
        }
      }

      ModesEnum = {
        PlanTab : 0,
        ShopTab : 1
      };

      var mode = ModesEnum.PlanTab;

      function Distance(lat1, lon1, lat2, lon2) {
        var radlat1 = Math.PI * lat1/180;
        var radlat2 = Math.PI * lat2/180;
        var radlon1 = Math.PI * lon1/180;
        var radlon2 = Math.PI * lon2/180;
        var theta = lon1 - lon2;
        var radtheta = Math.PI * theta/180;
        var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
        dist = Math.acos(dist);
        dist = dist * 180/Math.PI;
        dist = dist * 60 * 1.1515;
        return dist * 1.609344;
      }

      function FindNearestStore() {
        var name = undefined;

        if (currentLocation) {
          var nearestDistance = Distance(currentLocation.latitude, currentLocation.longitude, stores[0].latitude, stores[0].longitude);
          
          for (var i = 1; i < stores.length; ++i) {
            var distance = Distance(currentLocation.latitude, currentLocation.longitude, stores[i].latitude, stores[i].longitude);
            if (nearestDistance > distance) {
              name = stores[i].name;
              nearestDistance = distance;
            }
          }

          if (nearestDistance > 0.05) {
            name = undefined;
          }          
        }

        return name;
      }

      function PlanUi() {
        $(".content").append("<ul class=\"table-view\"></ul>");

        var list = $(".content .table-view");
        var anyDoneItems = false;
        for (var idx = 0; idx < itemsList.length; ++idx)
        {
          var item = itemsList[idx];
          if (!item.done) {
            list.append("<li itemIdx=\"" + idx + "\" class=\"table-view-cell\"><span style=\"padding-left:10px\">" + item.text +"</span></li>");
          }
        }

        $("#addItem").show();
        $("#editItems").show();
      }

      function AddItem(itemText)
      {
        itemsList.push({ text:itemText, done:false, addedLocation: currentLocation });
        localStorage['itemsList'] = JSON.stringify(itemsList);
      }

      function CheckItem(itemIdx, done)
      {
        var item = itemsList[itemIdx];

        item.done = done;
        if (done) 
        {
          if (!item.date) 
          {
            item.date = new Date();
            item.doneLocation = currentLocation;
          }
        } else {
          delete item.date;
        }

        localStorage['itemsList'] = JSON.stringify(itemsList);
      }

      function supports_geolocation() {
        return 'geolocation' in navigator;
      }

      function ShopUi() {        
        $(".content").append("<ul class=\"table-view\"></ul>");
        var list = $(".content .table-view");
        var anyDoneItems = false;
        for (var idx = 0; idx < itemsList.length; ++idx)
        {
          var item = itemsList[idx];
          if (!item.done) {
            list.append("<li itemIdx=\"" + idx + "\" class=\"table-view-cell\"><input type=\"checkbox\"/><span style=\"padding-left:10px\">" + item.text +"</span></li>");
          } else {
            anyDoneItems = true;
          }
        }

        if (anyDoneItems) {
          var doneItems = {};

          for (var idx = 0; idx < itemsList.length; ++idx)
          {
            var item = itemsList[idx];

            if (item.done) {
              var doneItem = doneItems[item.text];
              if (!doneItem || !doneItem.date || doneItem.date.getTime() < item.date.getTime()) {
                  doneItems[item.text] = idx;
              }
            }
          }

          list.append("<li id=\"table-divider\" class=\"table-view-cell table-view-divider\">Done</li>");
          for (var itemText in doneItems)
          {
            var idx = doneItems[itemText];
            var item = itemsList[idx];

            if (item.done) {
              var text = item.text;

              if (item.date)
              {
                var seconds = Math.floor(((new Date()).getTime() - item.date.getTime())/1000);
                var minutes = Math.floor(seconds/60);
                var hours = Math.floor(minutes/60);
                var days = Math.floor(hours/24);

                if (days > 0) {
                  text += " (" + days + "day" + (days == 1 ? "" : "s") + ")";
                } else if (hours > 0) {
                  text += " (" + hours + "hr" + (hours == 1 ? "" : "s") + ")";
                } else if (minutes > 0) {
                  text += " (" + minutes + "min" + (minutes == 1 ? "" : "s") + ")";
                } else {
                  text += " (now)";
                }
              }

              list.append("<li itemIdx=\"" + idx + "\" class=\"table-view-cell\">" + 
                (days + hours == 0 ? "<input type=\"checkbox\" checked=\"checked\"/>" : "")
                + "<span style=\"padding-left:10px\">" + text +"</span></li>");
            }
          }
        }

        $(".content .table-view li input").click(function() {
            var itemIdx = $(this).parent().attr("itemIdx");
            CheckItem(itemIdx, this.checked);
            UpdateUi();
        });

        $("#addItem").hide();
        $("#editItems").hide();
      }

      function UpdateCoordinates(lat, lng) {
        currentLocation.latitude = lat;
        currentLocation.longitude = lng;

        if (decideMode) {
          decideMode = false;

          if (FindNearestStore()) {
            mode = ModesEnum.ShopTab;
            UpdateUi();
          }
        }
      }

      function UpdateUi() {
        navigator.geolocation.getCurrentPosition(function(location) {
          UpdateCoordinates(location.coords.latitude, location.coords.longitude);
        });

        $(".content").empty();

        if (mode == ModesEnum.PlanTab) {
          $("#PlanTab").addClass("active");
          $("#ShopTab").removeClass("active");
          PlanUi();
        } else if (mode == ModesEnum.ShopTab) {
          $("#PlanTab").removeClass("active");
          $("#ShopTab").addClass("active");
          ShopUi();
        }        
      }

      $(document).ready(function() {
          $("#addItem").click(function() {
              $(".content .table-view").prepend("<input id=\"newItemEdit\"type=\"text\" placeholder=\"new item\" autocomplete=\"off\" spellcheck=\"false\"/>");
              
              $(":input").autocomplete({ 
                lookup: groceries,
                onSelect: function (suggestion) {
                  $("#newItemEdit").focus();
                }
              });

              $(":input").blur(function() {
                if ($(".autocomplete-suggestions:visible").length == 0) {
                  var itemText = $("#newItemEdit").val();
                  $("#newItemEdit").remove();
                  
                  if (itemText)
                  {
                    itemText = itemText.charAt(0).toUpperCase() + itemText.slice(1);
                    AddItem(itemText);
                    UpdateUi();
                  }
                }
              });
              $("#newItemEdit").focus();
          });

          $("#editItems").click(function() {
              $("#editItems").hide();
              $("#addItem").hide();
              $("#doneEditItems").show();
              $(".table-view .table-view-cell").not('.table-view-divider').append("<button class=\"btn btn-negative btn-remove\">Remove</button>");
              $(".btn-remove").click(function() {
                if ($(this).hasClass("btn-negative")) {
                  $(this).parent().css("text-decoration", "line-through");
                  $(this).text("Cancel");
                  $(this).removeClass("btn-negative");
                  $(this).addClass("btn-primary");
                } else {
                  $(this).parent().css("text-decoration", "");
                  $(this).text("Remove");
                  $(this).removeClass("btn-primary");
                  $(this).addClass("btn-negative");                  
                }
              });
          });

          $("#doneEditItems").click(function() {
              $(".table-view .table-view-cell").filter(function() {
                return $(this).css('text-decoration').indexOf("line-through") != -1;
              }).each(function() {
                var idx = parseInt($(this).attr("itemIdx"));
                delete itemsList[idx];
              })

              itemsList = jQuery.grep(itemsList, function(item){
                  return item !== undefined;
              });
              localStorage['itemsList'] = JSON.stringify(itemsList);

              $("#doneEditItems").hide();
              $("#editItems").show();
              $("#addItem").show();
              UpdateUi();
          });

          $(".tab-item").click(function() {
              mode = ModesEnum[$(this)[0].id];
              UpdateUi();
          });

          UpdateUi();
      });
    </script>
  </head>
  <body>

    <!-- Make sure all your bars are the first things in your <body> -->
    <header class="bar bar-nav">
      <a id="addItem" class="icon icon-plus pull-left"></a>
      <button id="editItems" class="btn pull-right">Edit</button>
      <button id="doneEditItems" class="btn pull-right btn-positive" style="display:none">Done</button>
      <h1 class="title">Grocery List</h1>
    </header>

    <!-- Wrap all non-bar HTML in the .content div (this is actually what scrolls) -->
    <div class="content">
    </div>

    <nav class="bar bar-tab">
      <a id="PlanTab" class="tab-item" href="#">
        <span class="icon icon-list"></span>
        <span class="tab-label">Plan</span>
      </a>
      <a id="ShopTab" class="tab-item" href="#">
        <span class="icon icon-gear"></span>
        <span class="tab-label">Shop</span>
      </a>
    </nav>
  </body>
</html>